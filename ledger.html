<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HC 記帳系統 - 記帳</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
<div id="ledger-page"></div>

<div class="page-wrap">
  <div class="card">
    <header class="header-row">
      <div>
        <h1 class="title">HC 記帳系統</h1>
        <div id="hello-bar" class="small text-gray">讀取中…</div>
      </div>
      <div class="header-actions">
        <button type="button" class="btn-secondary" onclick="handleLogout()">登出</button>
      </div>
    </header>

    <p id="js-status" class="small text-green">JS 載入中…</p>

    <!-- 新增 / 編輯 記帳表單 -->
    <section class="section" id="ledger-input">
      <h2 class="section-title">新增 / 編輯 記帳</h2>

      <p id="edit-status" class="small text-blue"></p>

      <div class="form-grid">
        <div class="form-row">
          <label for="entry-date">日期</label>
          <input id="entry-date" type="date" />
        </div>

        <div class="form-row">
          <label for="entry-type">類型</label>
          <select id="entry-type">
            <option value="expense">支出</option>
            <option value="income">收入</option>
          </select>
        </div>

        <div class="form-row">
          <label for="entry-category">分類</label>
          <input id="entry-category" type="text" placeholder="例如：餐飲 / 交通 / 薪資收入" list="category-list" />
          <datalist id="category-list"></datalist>
        </div>

        <div class="form-row">
          <label for="entry-item">項目</label>
          <input id="entry-item" type="text" placeholder="例如：晚餐便當 / 高鐵票 / 一月薪水" />
        </div>

        <div class="form-row">
          <label for="entry-amount">金額</label>
          <input id="entry-amount" type="number" min="1" step="1" placeholder="例如：250" />
        </div>

        <div class="form-row">
          <label for="entry-place">地點（可不填）</label>
          <input id="entry-place" type="text" placeholder="例如：全聯 / 7-11 / 星巴克" list="place-list" />
          <datalist id="place-list"></datalist>
        </div>
      </div>

      <div class="button-row">
        <button id="entry-submit-btn" type="button" class="btn-primary" onclick="submitEntry()">新增記帳</button>
        <button id="entry-cancel-edit-btn" type="button" class="btn-secondary hidden" onclick="cancelEditEntry()">取消編輯</button>
      </div>
    </section>

    <!-- 語音文字輸入版 -->
    <section class="section" id="voice-section">
      <h2 class="section-title">語音記帳（文字輸入版）</h2>
      <p class="small">
        建議每筆格式：<br/>
        <code>今天 支出 餐飲 晚餐便當 250 在全聯</code><br/>
        <code>昨天 收入 薪資收入 一月薪水 30000</code><br/>
        也可用關鍵字：<code>地點全聯</code> / <code>在全聯</code>（兩種都支援）<br/>
        多筆可用「下一筆」分隔：<br/>
        <code>今天 支出 餐飲 晚餐便當 250 在全聯 下一筆 昨天 支出 交通 搭車 100</code>
      </p>

      <div class="form-row">
        <label for="voice-text-input">語音文字輸入區</label>
        <textarea id="voice-text-input" rows="4" placeholder="貼上語音輸入文字，或直接輸入。"></textarea>
      </div>

      <div class="button-row">
        <button id="parse-text-btn" type="button" class="btn-secondary">解析文字</button>
        <button id="voice-text-clear-btn" type="button" class="btn-secondary">清空文字區</button>
        <button id="voice-clear-btn" type="button" class="btn-secondary" disabled>清除暫存</button>
        <button id="voice-confirm-btn" type="button" class="btn-primary" disabled>✅ 確認送出</button>
      </div>

      <p id="voice-status" class="small text-gray">尚未解析任何語音文字。</p>

      <h3 class="section-subtitle">語音解析預覽（按下確認才會寫入資料庫）</h3>
      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>#</th>
            <th>日期</th>
            <th>類型</th>
            <th>分類</th>
            <th>項目</th>
            <th>金額</th>
            <th>地點</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="voice-preview-body">
          <tr><td colspan="8">尚無語音解析資料</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 記帳紀錄列表 -->
    <section class="section" id="ledger-list">
      <h2 class="section-title">
        記帳紀錄
        <button type="button" class="btn-secondary" style="margin-left:auto;" onclick="exportCsv()">匯出 CSV</button>
      </h2>

      <div class="small text-gray" style="margin-bottom:6px;">
        範圍：
        <input type="date" id="filter-start" />
        ～
        <input type="date" id="filter-end" />
        <button type="button" class="btn-secondary" onclick="applyDateFilter()">套用</button>
        <button type="button" class="btn-secondary" onclick="quickRange('14d')">最近兩週</button>
        <button type="button" class="btn-secondary" onclick="quickRange('30d')">最近30天</button>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>日期</th>
            <th>類型</th>
            <th>分類</th>
            <th>項目</th>
            <th>金額</th>
            <th>地點</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="ledger-tbody">
          <tr><td colspan="7">載入中...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 統計 -->
    <section class="section" id="stats-section">
      <h2 class="section-title">統計</h2>
      <p class="small">
        總收入：<span id="stat-income" class="text-green">0</span>　
        總支出：<span id="stat-expense" class="text-red">0</span>　
        淨額：<span id="stat-net" class="text-blue">0</span>
      </p>

      <h3 class="section-subtitle">各分類支出合計</h3>
      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>分類</th>
            <th>支出金額</th>
          </tr>
          </thead>
          <tbody id="stats-category-body">
          <tr><td colspan="2">尚無資料</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Debug 訊息</h2>
      <pre id="debug" class="debug-box"></pre>
    </section>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
